---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import StatCard from '../../components/dashboard/StatCard.astro';
import Button from '../../components/ui/Button.astro';
import ExpenseModal from '../../components/dashboard/ExpenseModal.jsx';
---
<DashboardLayout title="Ringkasan Shift">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <StatCard title="Total Pendapatan (Omzet)" value="Rp 0" id="total-revenue" />
    <StatCard title="Total Pengeluaran" value="Rp 0" id="total-expenses" />
    <StatCard title="Pendapatan Bersih" value="Rp 0" id="net-income" color="bg-emerald-50" />
  </div>

  <div class="bg-white rounded-2xl p-8 border border-slate-100 grid md:grid-cols-2 gap-8 items-center">
    <div>
      <h3 class="text-xl font-bold text-slate-900 mb-2">Aktivitas Shift</h3>
      <p class="text-slate-500 mb-6">Scan nota baru atau catat pengeluaran shift hari ini.</p>
      <div class="flex flex-col md:flex-row gap-4">
        <a href="/dashboard/scan" class="flex-1">
          <Button>ðŸ“¸ Scan Nota</Button>
        </a>
        <Button variant="outline" id="add-expense-btn">ðŸ’¸ Catat Pengeluaran</Button>
      </div>
    </div>
    <div class="bg-slate-50 rounded-xl p-6 border text-center">
      <p class="text-slate-500 text-sm">Transaksi Tercatat</p>
      <p class="text-5xl font-bold text-slate-900" id="transaction-count">0</p>
    </div>
  </div>
  
  <ExpenseModal client:load />
</DashboardLayout>

<script>
  import { api } from '../../services/api.js';
  import { dashboardData } from '../../stores/user.js';
  
  function formatCurrency(value) {
    return `Rp ${(value || 0).toLocaleString('id-ID')}`;
  }

  function updateUI(data) {
    document.getElementById('total-revenue').textContent = formatCurrency(data.totalRevenue);
    document.getElementById('total-expenses').textContent = formatCurrency(data.totalExpenses);
    document.getElementById('net-income').textContent = formatCurrency(data.netIncome);
    document.getElementById('transaction-count').textContent = data.transactionCount || 0;
  }

  // Ambil data saat halaman load
  document.addEventListener('DOMContentLoaded', async () => {
    const data = await api.getDashboard();
    dashboardData.set(data);
  });

  // Dengarkan perubahan dari store
  dashboardData.subscribe(data => {
    if (data) updateUI(data);
  });
  
  // Script untuk Modal
  let isModalOpen = false;
  const modal = document.querySelector('[data-expense-modal-container]');

  function toggleModal(state) {
    isModalOpen = state;
    if (modal) {
      modal.style.display = isModalOpen ? 'flex' : 'none';
    }
  }

  document.getElementById('add-expense-btn').addEventListener('click', () => toggleModal(true));
  
  // Buat event listener global karena modal dirender oleh React
  window.addEventListener('expense-modal-close', () => toggleModal(false));
</script>

<style>
  [data-expense-modal-container] { display: none; }
</style>
EOFExpenseModal.jsxbash
cat > src/components/dashboard/ExpenseModal.jsx <<EOF
import { useState } from 'react';
import { api } from '../../services/api';
import { dashboardData } from '../../stores/user';

export default function ExpenseModal() {
  const [isOpen, setIsOpen] = useState(false);
  const [description, setDescription] = useState('');
  const [amount, setAmount] = useState('');
  const [loading, setLoading] = useState(false);

  const openModal = () => setIsOpen(true);
  const closeModal = () => {
      setIsOpen(false);
      window.dispatchEvent(new CustomEvent('expense-modal-close'));
  }

  useState(() => {
    const btn = document.getElementById('add-expense-btn');
    if (btn) btn.addEventListener('click', openModal);
  }, []);

  if (!isOpen) return null;

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!description || !amount) return;
    setLoading(true);
    try {
      const result = await api.addExpense(description, parseFloat(amount));
      if (result.success) {
        dashboardData.set(result.report);
        closeModal();
        setDescription('');
        setAmount('');
      } else {
        alert('Gagal menambah pengeluaran');
      }
    } catch (err) {
      alert('Error koneksi');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div data-expense-modal-container className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
        <h3 className="text-xl font-bold mb-6 text-slate-800">Tambah Pengeluaran</h3>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-sm font-medium text-slate-700 mb-1">Deskripsi</label>
            <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200" required />
          </div>
          <div className="mb-6">
            <label className="block text-sm font-medium text-slate-700 mb-1">Jumlah (Rp)</label>
            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200" required />
          </div>
          <div className="flex gap-4">
            <button type="button" onClick={closeModal} className="flex-1 py-3 px-4 rounded-xl font-bold border-2 border-slate-200 text-slate-600">Batal</button>
            <button type="submit" disabled={loading} className="flex-1 py-3 px-4 rounded-xl font-bold bg-slate-900 text-white">{loading ? 'Menyimpan...' : 'Simpan'}</button>
          </div>
        </form>
      </div>
    </div>
  );
}
